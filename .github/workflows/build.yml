on: push

name: Test reproducibility of Rust dylib builds

jobs:
  update-registry:
    runs-on: ubuntu-20.04
    outputs:
      head: ${{ steps.ls-crates-io-index.outputs.head }}
    steps:
      - uses: actions/checkout@v2

      - id: ls-crates-io-index
        name: Get head commit hash of crates.io registry index
        run: |
          commit=$(
            git ls-remote --heads https://github.com/rust-lang/crates.io-index.git master |
            cut -f 1
          )
          echo "::set-output name=head::$commit"
      - name: Cache cargo registry index
        uses: actions/cache@v2
        with:
          path: ~/.cargo/registry/index
          key: cargo-index-${{ steps.ls-crates-io-index.outputs.head }}
          restore-keys: cargo-index-

      - run: cargo fetch

  build:
    needs: update-registry
    strategy:
      matrix:
        os: [ubuntu-20.04, macos-latest, windows-latest]
        build: [a, b]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v2

      - name: Install latest stable toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Restore cargo registry
        uses: actions/cache@v2
        with:
          path: ~/.cargo/registry/index
          key: cargo-index-${{ needs.update-registry.outputs.head }}
          restore-keys: cargo-index-

      - name: Build the binaries
        uses: actions-rs/cargo@v1
        env:
          RUSTFLAGS: -C prefer-dynamic=yes
          CARGO_INCREMENTAL: 0
        with:
          command: build
          args: >
            --target-dir target-${{ matrix.build }}
            --verbose --release
            --lib --bin hello-world

      - name: Collect output binaries
        shell: bash
        run: |
          case '${{ matrix.os }}' in
            ubuntu-*  ) dylib_name=libhello_world.so;;
            macos-*   ) dylib_name=libhello_world.dylib;;
            windows-* ) dylib_name=hello_world.dll;;
          esac
          artifact_dir=output/${{ matrix.os }}-${{ matrix.build }}
          mkdir -p $artifact_dir
          cp target-${{ matrix.build }}/release/{${dylib_name},hello-world} $artifact_dir

      - uses: actions/upload-artifact@v2
        with:
          name: binaries
          path: output
